<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
  <title>AR Animation - Force THREE Mesh</title>

  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar-nft.js"></script>

  <style>
    body { margin:0; overflow:hidden; background:#000; }
    #hud{
      position:fixed; left:10px; top:10px; z-index:99999;
      font:12px/1.35 monospace; color:#0f0;
      background:rgba(0,0,0,.6); padding:10px; border-radius:6px;
      white-space:pre;
    }
  </style>
</head>
<body>
  <div id="hud">loading...</div>

  <a-scene
    embedded
    vr-mode-ui="enabled:false"
    renderer="antialias:true; alpha:true;"
    arjs="trackingMethod: best; sourceType: webcam;
          sourceWidth: 640; sourceHeight: 480; displayWidth: 640; displayHeight: 480;
          debugUIEnabled: false;">

    <a-nft id="nft" type="nft" url="https://leemile.github.io/AR"
      smooth="true" smoothCount="5" smoothTolerance="0.08" smoothThreshold="2">
      <!-- 컨테이너(엔티티)로만 사용 -->
      <a-entity id="container" position="0 0 0.02" rotation="-90 0 0" visible="false"></a-entity>
    </a-nft>

    <a-entity camera></a-entity>
  </a-scene>

  <script>
    window.addEventListener('load', () => {
      const hud = document.getElementById('hud');
      const nft = document.getElementById('nft');
      const container = document.getElementById('container');

      const totalFrames = 22;
      const textures = new Array(totalFrames);
      let loaded = 0;

      let mesh = null;
      let material = null;

      let rafId = null;
      let playing = false;
      let idx = 0;
      let last = 0;

      function renderHUD(extra='') {
        hud.textContent =
`tracking(nft.visible): ${!!nft.object3D.visible}
loaded: ${loaded}/${totalFrames}
container.visible: ${container.getAttribute('visible')}
playing: ${playing}
frame: ${idx}
${extra}`;
      }

      // 1) 텍스처 로드
      const texLoader = new THREE.TextureLoader();
      texLoader.setCrossOrigin('anonymous');

      for (let i = 0; i < totalFrames; i++) {
        const num = String(i).padStart(3,'0');
        const url = `https://leemile.github.io/frames/frame_${num}.png`;
        texLoader.load(url, (tex) => {
          textures[i] = tex;
          loaded++;
          renderHUD();
        }, undefined, (err) => {
          console.error('Texture fail:', url, err);
          renderHUD('texture fail');
        });
      }

      // 2) 우리가 직접 THREE plane mesh를 만들어 container에 붙이기
      function ensureMesh() {
        if (mesh) return;

        const geo = new THREE.PlaneGeometry(2.0, 2.0);
        material = new THREE.MeshBasicMaterial({
          map: null,
          transparent: true,
          side: THREE.DoubleSide,
          depthTest: false,
          depthWrite: false
        });
        mesh = new THREE.Mesh(geo, material);

        // 무조건 위에 그리기
        mesh.renderOrder = 999;
        container.object3D.renderOrder = 999;

        container.object3D.add(mesh);
        console.log('THREE mesh attached to container');
      }

      function setFrame(i) {
        if (!material || !textures[i]) return;
        material.map = textures[i];
        material.needsUpdate = true;
      }

      function loop(t) {
        if (!playing) return;
        if (t - last > 80) {
          setFrame(idx);
          idx = (idx + 1) % totalFrames;
          last = t;
          renderHUD();
        }
        rafId = requestAnimationFrame(loop);
      }

      function start() {
        if (playing) return;
        if (loaded !== totalFrames) return;

        ensureMesh();
        container.setAttribute('visible', true);

        idx = 0;
        last = 0;
        setFrame(0);

        playing = true;
        rafId = requestAnimationFrame(loop);
        console.log('START');
        renderHUD('START');
      }

      function stop() {
        if (!playing) return;
        playing = false;
        if (rafId) cancelAnimationFrame(rafId);
        rafId = null;

        container.setAttribute('visible', false);
        console.log('STOP');
        renderHUD('STOP');
      }

      // 추적 상태 폴링
      setInterval(() => {
        const tracking = !!(nft.object3D && nft.object3D.visible);
        if (tracking) start();
        else stop();
      }, 100);

      renderHUD();
    });
  </script>
</body>
</html>
