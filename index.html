<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2D PNG Frame Animation</title>
    <style>
      .arjs-loader {
        position: absolute; top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: flex; justify-content: center; align-items: center;
        color: white; font-size: 1.2em;
        z-index: 9999;
      }
      .tracking-status {
        position: absolute; top: 10px; left: 10px;
        color: white; background: rgba(0, 0, 0, 0.6); padding: 10px;
        border-radius: 5px; font-size: 1em;
        z-index: 10000; display: none;
      }
    </style>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
  </head>
  <body style="margin: 0; overflow: hidden;">
    <div class="arjs-loader">
      Loading AR assets, please wait...
    </div>
    <div class="tracking-status" id="trackingStatus">Tracking Lost</div>

    <a-scene embedded vr-mode-ui="enabled:false"
             renderer="logarithmicDepthBuffer:true"
             arjs="trackingMethod: best; sourceType: webcam; detectionMode: mono; debugUIEnabled: false; maxDetectionRate: 30;">
      <!-- NFT Marker -->
      <a-nft id="nftMarker" type="nft" url="AR"
             smooth="true" smoothCount="10"
             smoothTolerance="0.05" smoothThreshold="15">
        <a-plane id="animPlane"
                 position="0 0 0" rotation="-90 0 0"
                 width="2" height="2"
                 visible="false">
        </a-plane>
      </a-nft>
      <a-entity camera></a-entity>
    </a-scene>

    <script>
      const plane = document.querySelector("#animPlane");
      const marker = document.querySelector("#nftMarker");
      const trackingStatus = document.getElementById("trackingStatus");
      const totalFrames = 23;
      const textures = [];
      let currentFrame = 0;
      let interval = null;

      // PNG 파일 로드
      const loader = new THREE.TextureLoader();
      for (let i = 0; i < totalFrames; i++) {
        const num = String(i).padStart(3, "0");
        const filePath = `frames/frame_${num}.png`;
        textures[i] = loader.load(filePath, 
          (texture) => console.log(`Texture loaded: ${filePath}`),
          undefined,
          (error) => console.error(`Failed to load texture: ${filePath}`, error)
        );
      }

      // 애니메이션 처리
      function animate() {
        const mesh = plane.getObject3D("mesh");
        if (!mesh || !mesh.material) {
          console.error("No mesh or material found.");
          return;
        }
        mesh.material.map = textures[currentFrame];
        mesh.material.needsUpdate = true;
        currentFrame = (currentFrame + 1) % totalFrames;
      }

      // 애니메이션 시작
      function startAnimation() {
        plane.setAttribute("visible", true);
        interval = setInterval(animate, 100); // 약 10fps
        trackingStatus.style.display = "none";
      }

      // 애니메이션 중지
      function stopAnimation() {
        clearInterval(interval);
        interval = null;
        currentFrame = 0; // 초기화
        plane.setAttribute("visible", false);
        trackingStatus.style.display = "block";
        console.log("Marker Lost!");
      }

      // 마커 이벤트 바인딩
      marker.addEventListener("markerFound", () => {
        console.log("Marker Found!");
        startAnimation();
      });

      marker.addEventListener("markerLost", stopAnimation);

      // 로딩 화면 숨기기
      window.addEventListener("load", () => {
        document.querySelector(".arjs-loader").style.display = "none";
      });
    </script>
  </body>
</html>
