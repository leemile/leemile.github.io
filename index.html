<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>2D PNG Frame Animation (Mobile Fix)</title>
  <style>
    .arjs-loader {
      position: fixed; inset: 0;
      display: flex; align-items: center; justify-content: center;
      background: rgba(0,0,0,0.85); color: white; font-size: 1.2em;
      z-index: 9999;
    }
    .tracking-status {
      position: fixed; top: 10px; left: 10px;
      padding: 10px; background: rgba(0,0,0,0.6); color: white;
      border-radius: 5px; z-index: 10000; display: none;
    }
  </style>
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
</head>
<body style="margin:0; overflow:hidden; background:black;">
  <div class="arjs-loader">Loading AR assets, please wait...</div>
  <div class="tracking-status" id="trackingStatus">Tracking Lost</div>

  <a-scene
    embedded
    vr-mode-ui="enabled:false"
    renderer="logarithmicDepthBuffer:true"
    arjs="trackingMethod: best; sourceType: webcam; detectionMode: mono; debugUIEnabled: false; maxDetectionRate: 30;"
  >
    <a-nft
      id="nftMarker"
      type="nft"
      url="AR"
      smooth="true"
      smoothCount="10"
      smoothTolerance="0.05"
      smoothThreshold="15"
    >
      <a-plane
        id="animPlane"
        position="0 0 0" rotation="-90 0 0"
        width="2" height="2"
        visible="false"
      ></a-plane>
    </a-nft>
    <a-entity camera></a-entity>
  </a-scene>

  <script>
    const plane = document.querySelector('#animPlane');
    const marker = document.querySelector('#nftMarker');
    const trackingStatus = document.getElementById('trackingStatus');
    const loaderEl = document.querySelector('.arjs-loader');

    const totalFrames = 23;
    const textures = [];
    let texturesReady = false;
    let planeMesh = null;
    let material = null;
    let currentFrame = 0;
    let rafId = null;
    let playing = false;

    // 전역 에러 로깅: 에러 발생 시 로더가 안 사라지는 원인을 찾기 위함
    window.onerror = (msg, src, line, col, err) => {
      console.error('Global Error:', msg, src, line, col, err);
    };

    function waitForPlaneMesh(el) {
      return new Promise((resolve) => {
        const check = () => {
          const mesh = el.getObject3D('mesh');
          if (mesh) return resolve(mesh);
          setTimeout(check, 50);
        };
        el.addEventListener('object3dset', (e) => {
          if (e.detail.type === 'mesh') check();
        });
        el.addEventListener('loaded', check);
        check();
      });
    }

    // 텍스처 로드
    const loader = new THREE.TextureLoader();
    let loadedCount = 0;
    for (let i = 0; i < totalFrames; i++) {
      const num = String(i).padStart(3, '0');
      const filePath = `frames/frame_${num}.png`;
      textures[i] = loader.load(
        filePath,
        () => {
          loadedCount++;
          if (loadedCount === totalFrames) {
            texturesReady = true;
            console.log('All textures loaded');
          }
        },
        undefined,
        (error) => console.error(`Failed to load texture: ${filePath}`, error)
      );
    }

    function animate() {
      if (!playing || !planeMesh || !material) return;
      material.map = textures[currentFrame];
      material.needsUpdate = true;
      currentFrame = (currentFrame + 1) % totalFrames;
      rafId = requestAnimationFrame(animate);
    }

    function tryStart() {
      if (playing) return;
      if (!planeMesh || !texturesReady) {
        console.warn('Not ready yet (mesh or textures)');
        return;
      }
      if (!material) {
        material = new THREE.MeshBasicMaterial({
          map: textures[0],
          transparent: true,
          side: THREE.DoubleSide,
        });
        planeMesh.material = material;
      }
      plane.setAttribute('visible', true);
      trackingStatus.style.display = 'none';
      playing = true;
      animate();
    }

    function stop() {
      if (rafId) cancelAnimationFrame(rafId);
      rafId = null;
      playing = false;
      currentFrame = 0;
      if (material && textures[0]) {
        material.map = textures[0];
        material.needsUpdate = true;
      }
      plane.setAttribute('visible', false);
      trackingStatus.style.display = 'block';
    }

    marker.addEventListener('markerFound', () => {
      console.log('Marker Found');
      tryStart();
    });
    marker.addEventListener('markerLost', () => {
      console.log('Marker Lost');
      stop();
    });

    // plane mesh 준비
    waitForPlaneMesh(plane).then((mesh) => {
      console.log('Plane mesh ready');
      planeMesh = mesh;
    });

    // 씬 로드 완료 시점에 로더 제거 (추가 안전장치)
    document.querySelector('a-scene').addEventListener('loaded', () => {
      loaderEl.style.display = 'none';
    });

    // AR.js에서 카메라 스트림 실패 대비: 5초 후에도 재생 안 되면 알림
    setTimeout(() => {
      if (!texturesReady || !planeMesh) {
        console.warn('Still loading resources… (check camera permission, HTTPS, file paths)');
      }
    }, 5000);
  </script>
</body>
</html>
