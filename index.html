<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>2D PNG Frame Animation (Stable)</title>
    <style>
      .arjs-loader {
        position: absolute; top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(0,0,0,0.8);
        display: flex; justify-content: center; align-items: center;
        color: white; font-size: 1.2em; z-index: 9999;
      }
      .tracking-status {
        position: absolute; top: 10px; left: 10px;
        color: white; background: rgba(0,0,0,0.6); padding: 10px;
        border-radius: 5px; font-size: 1em; z-index: 10000; display: none;
      }
    </style>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
  </head>
  <body style="margin:0; overflow:hidden;">
    <div class="arjs-loader">Loading AR assets, please wait...</div>
    <div class="tracking-status" id="trackingStatus">Tracking Lost</div>

    <a-scene
      embedded
      vr-mode-ui="enabled:false"
      renderer="logarithmicDepthBuffer:true"
      arjs="trackingMethod: best; sourceType: webcam; detectionMode: mono; debugUIEnabled: false; maxDetectionRate: 30;"
    >
      <a-nft
        id="nftMarker"
        type="nft"
        url="AR"
        smooth="true"
        smoothCount="10"
        smoothTolerance="0.05"
        smoothThreshold="15"
      >
        <a-plane
          id="animPlane"
          position="0 0 0"
          rotation="-90 0 0"
          width="2"
          height="2"
          visible="false"
        ></a-plane>
      </a-nft>
      <a-entity camera></a-entity>
    </a-scene>

    <script>
      const plane = document.querySelector('#animPlane');
      const marker = document.querySelector('#nftMarker');
      const trackingStatus = document.getElementById('trackingStatus');

      const totalFrames = 23;
      const textures = [];
      let texturesReady = false;
      let planeMesh = null;
      let material = null;
      let currentFrame = 0;
      let rafId = null;
      let playing = false;

      // 1) plane mesh 준비 기다리기
      function waitForPlaneMesh(el) {
        return new Promise((resolve) => {
          const check = () => {
            const mesh = el.getObject3D('mesh');
            if (mesh) return resolve(mesh);
            setTimeout(check, 50);
          };
          el.addEventListener('object3dset', (e) => {
            if (e.detail.type === 'mesh') check();
          });
          el.addEventListener('loaded', check);
          check();
        });
      }

      // 2) 텍스처 로드
      const loader = new THREE.TextureLoader();
      let loadedCount = 0;
      for (let i = 0; i < totalFrames; i++) {
        const num = String(i).padStart(3, '0');
        const filePath = `frames/frame_${num}.png`;
        textures[i] = loader.load(
          filePath,
          () => {
            loadedCount++;
            if (loadedCount === totalFrames) {
              texturesReady = true;
              console.log('All textures loaded');
            }
          },
          undefined,
          (error) => console.error(`Failed to load texture: ${filePath}`, error)
        );
      }

      // 3) 애니메이션 루프
      function animate() {
        if (!playing || !planeMesh || !material) return;
        material.map = textures[currentFrame];
        material.needsUpdate = true;
        currentFrame = (currentFrame + 1) % totalFrames;
        rafId = requestAnimationFrame(animate);
      }

      // 4) 시작
      function tryStart() {
        if (playing) return;
        if (!planeMesh || !texturesReady) {
          console.warn('Not ready yet (mesh or textures)');
          return;
        }
        // 머티리얼이 없으면 생성
        if (!material) {
          material = new THREE.MeshBasicMaterial({
            map: textures[0],
            transparent: true,
            side: THREE.DoubleSide,
          });
          planeMesh.material = material;
        }
        plane.setAttribute('visible', true);
        trackingStatus.style.display = 'none';
        playing = true;
        animate();
      }

      // 5) 정지
      function stop() {
        if (rafId) cancelAnimationFrame(rafId);
        rafId = null;
        playing = false;
        currentFrame = 0;
        if (material) {
          material.map = textures[0];
          material.needsUpdate = true;
        }
        plane.setAttribute('visible', false);
        trackingStatus.style.display = 'block';
      }

      // 6) 마커 이벤트
      marker.addEventListener('markerFound', () => {
        console.log('Marker Found');
        tryStart();
      });
      marker.addEventListener('markerLost', () => {
        console.log('Marker Lost');
        stop();
      });

      // 7) plane mesh 준비 후 캐싱
      waitForPlaneMesh(plane).then((mesh) => {
        console.log('Plane mesh ready');
        planeMesh = mesh;
      });

      // 8) 로딩 화면 숨기기
      window.addEventListener('load', () => {
        document.querySelector('.arjs-loader').style.display = 'none';
      });
    </script>
  </body>
</html>
