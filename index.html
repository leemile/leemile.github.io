<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2D Animation AR - Debugged</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
    <style>
        .arjs-loader {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: black; display: flex; justify-content: center; align-items: center;
            color: white; z-index: 999;
        }
    </style>
</head>

<body style="margin: 0; overflow: hidden;">
    <div class="arjs-loader" id="loader">데이터를 로드 중입니다... 잠시만 기다려주세요.</div>

    <script>
        // 애니메이션 컴포넌트 정의
        AFRAME.registerComponent('sequence-animation', {
            schema: {
                total: { type: 'int', default: 22 }, // 총 프레임 수
                fps: { type: 'int', default: 15 }    // 초당 프레임 수
            },
            init: function () {
                this.textures = [];
                this.curr = 0;
                this.lastUpdate = 0;
                this.active = false;

                const loader = new THREE.TextureLoader();
                for (let i = 0; i < this.data.total; i++) {
                    const name = String(i).padStart(3, '0');
                    // 텍스처 미리 로드
                    this.textures.push(loader.load(`frames/frame_${name}.png`));
                }
            },
            tick: function (time, delta) {
                if (!this.active) return;

                // 설정한 FPS에 맞춰 프레임 교체
                if (time - this.lastUpdate > (1000 / this.data.fps)) {
                    const mesh = this.el.getObject3D('mesh');
                    if (mesh) {
                        mesh.material.map = this.textures[this.curr];
                        mesh.material.needsUpdate = true;
                    }
                    this.curr = (this.curr + 1) % this.data.total;
                    this.lastUpdate = time;
                }
            },
            start: function() { this.active = true; this.el.setAttribute('visible', true); },
            stop: function() { this.active = false; this.el.setAttribute('visible', false); }
        });
    </script>

    <a-scene embedded vr-mode-ui="enabled: false"
             arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;"
             renderer="antialias: true; alpha: true; precision: medium;">
        
        <a-nft id="nft-target" type="nft" url="AR" 
               smooth="true" smoothCount="10" smoothTolerance="0.01" smoothThreshold="5">
            
            <a-plane id="display-plane" 
                     rotation="-90 0 0" 
                     width="150" height="150" 
                     position="0 0 0"
                     material="transparent: true; shader: flat;"
                     sequence-animation="total: 22; fps: 15"
                     visible="false">
            </a-plane>
        </a-nft>

        <a-entity camera></a-entity>
    </a-scene>

    <script>
        const target = document.getElementById('nft-target');
        const plane = document.getElementById('display-plane');

        // 마커 감지 이벤트
        target.addEventListener('markerFound', () => {
            console.log("Marker Found!");
            plane.components['sequence-animation'].start();
        });

        // 마커 유실 이벤트
        target.addEventListener('markerLost', () => {
            console.log("Marker Lost");
            plane.components['sequence-animation'].stop();
        });

        // 로딩 완료 이벤트
        window.addEventListener("arjs-nft-loaded", () => {
            document.getElementById('loader').style.display = 'none';
        });
    </script>
</body>
</html>
