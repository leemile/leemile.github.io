<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AR Frame Animation</title>
    
    <script src="https://cdn.jsdelivr.net/gh/aframevr/aframe@1c2407b26c61958baa93960954db63587e51e848/dist/aframe-master.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>

    <style>
        .arjs-loader {
            height: 100%; width: 100%; position: absolute; top: 0; left: 0;
            background-color: rgba(0, 0, 0, 0.8); z-index: 9999;
            display: flex; justify-content: center; align-items: center;
        }
        .arjs-loader div {
            text-align: center; font-size: 1.25em; color: white;
        }
        #debug-ui {
            position: fixed; bottom: 10px; left: 10px; 
            background: rgba(0,0,0,0.7); color: lime; 
            padding: 5px; font-family: monospace; z-index: 10000;
            pointer-events: none;
        }
    </style>
</head>

<body style="margin: 0; overflow: hidden;">
    <div class="arjs-loader" id="loader">
        <div>
            NFT 마커 데이터를 로딩 중입니다...<br>
            (최대 1분 소요될 수 있습니다)
        </div>
    </div>

    <div id="debug-ui">초기화 중...</div>

    <script>
        // 디버그 로그 함수
        function log(msg) {
            console.log(msg);
            document.getElementById('debug-ui').innerText = msg;
        }

        // 애니메이션 컴포넌트
        AFRAME.registerComponent('frame-animation', {
            schema: {
                totalFrames: { type: 'int', default: 22 }, // 프레임 개수
                fps: { type: 'int', default: 15 }          // 속도
            },
            init: function() {
                this.textures = [];
                this.currentFrame = 0;
                this.lastTime = 0;
                this.isPlaying = false;
                
                const textureLoader = new THREE.TextureLoader();

                // 텍스처 미리 로드 (frames 폴더 경로 주의)
                for (let i = 0; i < this.data.totalFrames; i++) {
                    const num = String(i).padStart(3, '0');
                    const path = `./frames/frame_${num}.png`; 
                    
                    this.textures.push(textureLoader.load(path, 
                        () => {}, // 성공 시
                        undefined,
                        (err) => log(`이미지 로드 실패: ${path}`) // 실패 시
                    ));
                }
                log("이미지 로딩 완료. 마커를 찾으세요.");
            },
            tick: function(time, timeDelta) {
                if (!this.isPlaying) return;

                // FPS 제어 로직
                if (time - this.lastTime > (1000 / this.data.fps)) {
                    const mesh = this.el.getObject3D('mesh');
                    if (mesh && this.textures[this.currentFrame]) {
                        mesh.material.map = this.textures[this.currentFrame];
                        mesh.material.needsUpdate = true;
                    }
                    this.currentFrame = (this.currentFrame + 1) % this.data.totalFrames;
                    this.lastTime = time;
                }
            },
            play: function() {
                this.isPlaying = true;
                this.el.setAttribute('visible', true);
                log("애니메이션 재생 중...");
            },
            stop: function() {
                this.isPlaying = false;
                this.el.setAttribute('visible', false);
                log("마커를 놓쳤습니다.");
            }
        });
    </script>

    <a-scene
        vr-mode-ui="enabled: false;"
        renderer="logarithmicDepthBuffer: true; precision: medium;"
        embedded
        arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;">

        <a-nft
            id="nft-marker"
            type="nft"
            url="./assets/marker"
            smooth="true"
            smoothCount="10"
            smoothTolerance="0.01"
            smoothThreshold="5">
            
            <a-plane
                id="anim-plane"
                rotation="-90 0 0"
                position="50 0 -100" 
                width="150"
                height="150"
                material="transparent: true; shader: flat; side: double;"
                frame-animation="totalFrames: 22; fps: 15"
                visible="false">
            </a-plane>
        </a-nft>

        <a-entity camera></a-entity>
    </a-scene>

    <script>
        // 마커 이벤트 연결
        const marker = document.querySelector('#nft-marker');
        const plane = document.querySelector('#anim-plane');

        marker.addEventListener('markerFound', () => {
            plane.components['frame-animation'].play();
        });

        marker.addEventListener('markerLost', () => {
            plane.components['frame-animation'].stop();
        });

        // AR 시스템 로딩 완료 시 화면 전환
        window.addEventListener('arjs-nft-loaded', () => {
            document.getElementById('loader').style.display = 'none';
            log("AR 시스템 준비 완료! 마커를 비추세요.");
        });
    </script>
</body>
</html>
