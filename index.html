<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>WebAR Fixed Animation</title>
    <style>
      .arjs-loader {
        position: absolute; top:0; left:0;
        width:100%; height:100%;
        background: rgba(0,0,0,0.8);
        display:flex; justify-content:center; align-items:center;
        color:white; font-size:1.2em;
        z-index:9999;
      }
    </style>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
  </head>
  <body style="margin:0; overflow:hidden;">
    <div class="arjs-loader">
      Loading AR assets, please wait...
    </div>

    <a-scene embedded vr-mode-ui="enabled:false"
             renderer="logarithmicDepthBuffer:true"
             arjs="trackingMethod: best; sourceType: webcam; detectionMode: mono; debugUIEnabled: false; maxDetectionRate: 30;">
      <!-- NFT Marker -->
      <a-nft id="nftMarker" type="nft" url="AR"
             smooth="true" smoothCount="5"
             smoothTolerance="0.02" smoothThreshold="10">
        <a-plane id="animPlane"
                 position="0 0 0" rotation="-90 0 0"
                 width="2" height="2"
                 visible="false">
        </a-plane>
      </a-nft>
      <a-entity camera></a-entity>
    </a-scene>

    <script>
      const plane = document.querySelector('#animPlane');
      const marker = document.querySelector('#nftMarker');
      const totalFrames = 23;
      const textures = [];
      let current = 0;
      let interval = null;
      let meshReady = false;

      // THREE.TextureLoader로 PNG 시퀀스 로딩
      const loader = new THREE.TextureLoader();
      for (let i = 0; i < totalFrames; i++) {
        const num = String(i).padStart(3, '0');
        textures[i] = loader.load(`frames/frame_${num}.png`, (texture) => {
          texture.minFilter = THREE.LinearFilter; // Mipmap 비활성화
          texture.magFilter = THREE.LinearFilter;
          texture.generateMipmaps = false;
        });
      }

      // mesh 준비 감지
      plane.addEventListener('model-loaded', () => {
        meshReady = !!plane.getObject3D('mesh');
      });

      // 애니메이션 처리 (requestAnimationFrame)
      function animate() {
        if (!meshReady || !interval) return; // mesh가 준비되지 않으면 종료
        const mesh = plane.getObject3D('mesh');
        if (mesh && mesh.material) {
          mesh.material.map = textures[current];
          mesh.material.needsUpdate = true;
          current = (current + 1) % totalFrames;
        }
        interval = requestAnimationFrame(animate);
      }

      // 애니메이션 시작
      function startAnimation() {
        if (!meshReady) {
          setTimeout(startAnimation, 100); // mesh 준비를 기다림
          return;
        }
        const mesh = plane.getObject3D('mesh');
        if (!mesh || !mesh.material) return; // 유효한 mesh 확인

        plane.setAttribute('visible', true);
        if (!interval) {
          interval = requestAnimationFrame(animate);
        }
      }

      // 애니메이션 중지
      function stopAnimation() {
        if (interval) {
          cancelAnimationFrame(interval);
          interval = null;
        }
        current = 0; // 초기화
        plane.setAttribute('visible', false);
      }

      // 마커 이벤트 바인딩
      marker.addEventListener('markerFound', startAnimation);
      marker.addEventListener('markerLost', stopAnimation);

      // 로딩 화면 숨기기
      window.addEventListener('load', () => {
        document.querySelector('.arjs-loader').style.display = 'none';
      });
    </script>
  </body>
</html>
