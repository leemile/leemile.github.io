<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>WebAR PNG Animation (TextureLoader)</title>
    <style>
      .arjs-loader {
        position: absolute; top:0; left:0;
        width:100%; height:100%;
        background: rgba(0,0,0,0.8);
        display:flex; justify-content:center; align-items:center;
        color:white; font-size:1.2em;
        z-index:9999;
      }
    </style>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
  </head>
  <body style="margin:0; overflow:hidden;">
    <div class="arjs-loader"><div>Loading AR assets, please wait...</div></div>

    <a-scene embedded vr-mode-ui="enabled:false"
             renderer="logarithmicDepthBuffer:true;"
             arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;">
      
      <a-nft type="nft" url="AR"
             smooth="true" smoothCount="10" smoothTolerance="0.01" smoothThreshold="5"
             id="nftMarker">
        <a-entity id="animContainer">
          <a-plane id="animPlane"
                   position="0 0 0" rotation="-90 0 0"
                   width="2" height="2"
                   visible="false">
          </a-plane>
        </a-entity>
      </a-nft>

      <a-entity camera></a-entity>
    </a-scene>

    <script>
      const plane = document.querySelector('#animPlane');
      const marker = document.querySelector('#nftMarker');
      const totalFrames = 23;
      const textures = [];
      let interval = null;
      let current = 0;

      const loader = new THREE.TextureLoader();
      const mesh = plane.getObject3D('mesh');

      // 텍스처 미리 로드
      for (let i = 0; i < totalFrames; i++) {
        const filename = `frames/frame_${String(i).padStart(3, '0')}.png`;
        textures.push(loader.load(filename));
      }

      function startAnimation() {
        if (!mesh || textures.length === 0) return;

        plane.setAttribute('visible', 'true');
        if (interval) return; // 이미 실행 중이면 return

        interval = setInterval(() => {
          mesh.material.map = textures[current];
          mesh.material.needsUpdate = true;
          current = (current + 1) % totalFrames;
        }, 100);
      }

      function stopAnimation() {
        if (!mesh) return;
        clearInterval(interval);
        interval = null;
        current = 0;
        plane.setAttribute('visible', 'false');
      }

      // 마커 인식 이벤트 연결
      marker.addEventListener('markerFound', startAnimation);
      marker.addEventListener('markerLost', stopAnimation);

      // 로딩 완료 시 로딩 메시지 숨기기
      window.addEventListener('load', () => {
        document.querySelector('.arjs-loader').style.display = 'none';
      });
    </script>
  </body>
</html>
