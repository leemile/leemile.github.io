<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>AR Animation Stable</title>
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar-nft.js"></script>
  <style>
    body { margin:0; overflow:hidden; background:#000; }
    #loader {
      position:fixed; inset:0; display:flex; justify-content:center; align-items:center;
      background:black; color:white; z-index:999;
    }
  </style>
</head>
<body>
  <div id="loader"><p>시스템 안정화 로딩 중...</p></div>

  <a-scene
    embedded
    vr-mode-ui="enabled: false;"
    renderer="logarithmicDepthBuffer: true; antialias: true; alpha: true; precision: highp; colorManagement: true;"
    arjs="trackingMethod: best; sourceType: webcam; sourceWidth: 640; sourceHeight: 480; displayWidth: 640; displayHeight: 480; debugUIEnabled: false;">
      
    <a-nft
      id="nft-target"
      type="nft"
      url="https://leemile.github.io/AR"
      smooth="true"
      smoothCount="5"
      smoothTolerance="0.08"
      smoothThreshold="2">
        
      <a-plane
        id="ani-plane"
        position="0 0 0.02"
        rotation="-90 0 0"
        width="2.5" height="2.5"
        material="transparent: true; shader: flat; side: double; opacity: 1;"
        visible="false">
      </a-plane>
    </a-nft>

    <a-entity camera></a-entity>
  </a-scene>

  <script>
    window.addEventListener('load', () => {
      const nft = document.querySelector('#nft-target');
      const plane = document.querySelector('#ani-plane');
      const totalFrames = 22;
      const textures = [];
      
      let currentIdx = 0;
      let animationId = null;
      let lastUpdate = 0;
      let planeMesh = null;
      let texturesReady = false;
      let isMarkerVisible = false; // 마커가 현재 보이는지 상태 추적

      // 텍스처 로드 설정 (CORS 호환성 강화)
      const loader = new THREE.TextureLoader();
      loader.setCrossOrigin('anonymous'); 

      let loaded = 0;
      for (let i = 0; i < totalFrames; i++) {
        const frameNum = String(i).padStart(3, '0');
        loader.load(
          `https://leemile.github.io/frames/frame_${frameNum}.png`,
          (tex) => {
            textures[i] = tex;
            if (++loaded === totalFrames) {
              console.log('All textures loaded');
              texturesReady = true;
              tryStart(); // 로딩 끝나면 즉시 시작 시도
            }
          }
        );
      }

      // 애니메이션 루프
      function updateAnim(time) {
        if (time - lastUpdate > 80) { 
          if (planeMesh && textures[currentIdx]) {
            planeMesh.material.map = textures[currentIdx];
            planeMesh.material.needsUpdate = true;
          }
          currentIdx = (currentIdx + 1) % totalFrames;
          lastUpdate = time;
        }
        animationId = requestAnimationFrame(updateAnim);
      }

      // 시작 시도 함수 (핵심 수정)
      function tryStart() {
        // 1. 마커가 안 보이면 시작 안 함
        // 2. 리소스(메시, 텍스처)가 준비 안 됐으면 시작 안 함
        if (!isMarkerVisible || !planeMesh || !texturesReady) return;

        plane.setAttribute('visible', true);
        if (!animationId) {
          console.log('Animation Started');
          animationId = requestAnimationFrame(updateAnim);
        }
      }

      function stopAnim() {
        plane.setAttribute('visible', false);
        if (animationId) {
          cancelAnimationFrame(animationId);
          animationId = null;
        }
      }

      nft.addEventListener('markerFound', () => {
        console.log('Marker Found');
        isMarkerVisible = true;
        tryStart(); // 발견 즉시 시작 시도
      });

      nft.addEventListener('markerLost', () => {
        console.log('Marker Lost');
        isMarkerVisible = false;
        stopAnim();
      });

      window.addEventListener('arjs-nft-loaded', () => {
        document.querySelector('#loader').style.display = 'none';
      });

      // Mesh 감지
      const checkMesh = setInterval(() => {
        const mesh = plane.getObject3D('mesh');
        if (mesh) {
          clearInterval(checkMesh);
          planeMesh = mesh;
          
          // 렌더링 순서 최상위로 (가려짐 방지)
          planeMesh.renderOrder = 999;
          if (planeMesh.material) {
            planeMesh.material.depthTest = false;
            planeMesh.material.depthWrite = false;
          }
          
          console.log('Mesh ready');
          tryStart(); // 메시 준비되면 즉시 시작 시도
        }
      }, 100);
    });
  </script>
</body>
</html>
