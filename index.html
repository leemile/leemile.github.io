<!-- ... head 부분 동일 ... -->
<script>
  const nft = document.querySelector('#nft-target');
  const plane = document.querySelector('#ani-plane');
  const totalFrames = 22;
  const textures = [];
  let currentIdx = 0;
  let animationId = null;      // ← animationFrame 대신 일관되게 animationId 사용
  let lastUpdate = 0;

  // 텍스처 미리 로드 (기존 상대경로 그대로)
  const loader = new THREE.TextureLoader();
  for (let i = 0; i < totalFrames; i++) {
    const frameNum = String(i).padStart(3, '0');
    textures.push(loader.load(`./frames/frame_${frameNum}.png`));
  }

  window.addEventListener('arjs-nft-loaded', () => {
    document.querySelector('#loader').style.display = 'none';
  });

  function updateAnim(time) {
    if (time - lastUpdate > 80) { // 약 12 FPS
      const mesh = plane.getObject3D('mesh');
      if (mesh && textures[currentIdx]) {
        mesh.material.map = textures[currentIdx];
        mesh.material.needsUpdate = true;
      }
      currentIdx = (currentIdx + 1) % totalFrames;
      lastUpdate = time;
    }
    animationId = requestAnimationFrame(updateAnim);
  }

  nft.addEventListener('markerFound', () => {
    // 마커 위 정렬: 크기가 크면 150→작게, 혹은 z 위치 조정
    plane.setAttribute('position', {x:0, y:0, z:0.02});   // 살짝 띄우기
    plane.setAttribute('rotation', '-90 0 0');
    plane.setAttribute('width', 2.5);
    plane.setAttribute('height', 2.5);
    const mesh = plane.getObject3D('mesh');
    if (mesh && mesh.material) {       // 가려짐 방지
      mesh.material.depthTest = false;
      mesh.material.depthWrite = false;
    }
    plane.setAttribute('visible', true);
    if (!animationId) {
      animationId = requestAnimationFrame(updateAnim);
    }
  });

  nft.addEventListener('markerLost', () => {
    plane.setAttribute('visible', false);
    if (animationId) {
      cancelAnimationFrame(animationId);  // ← 여기서 animationId 사용
      animationId = null;
    }
  });
</script>
