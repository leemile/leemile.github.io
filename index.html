<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>AR Animation Stable</title>
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar-nft.js"></script>
  <style>
    body { margin:0; overflow:hidden; background:#000; }
    #loader { position:fixed; inset:0; display:flex; justify-content:center; align-items:center; background:#000; color:#fff; z-index:999; }
    #dbg { position:fixed; left:10px; bottom:10px; z-index:1000; color:#0f0; background:rgba(0,0,0,.5); padding:6px 10px; border-radius:4px; font-size:12px; }
  </style>
</head>
<body>
  <div id="loader"><p>시스템 안정화 로딩 중...</p></div>
  <div id="dbg">init...</div>

  <a-scene
    embedded
    vr-mode-ui="enabled:false"
    renderer="logarithmicDepthBuffer:true; antialias:true; alpha:true; precision:highp; colorManagement:true;"
    arjs="trackingMethod: best; sourceType: webcam;
          sourceWidth: 640; sourceHeight: 480; displayWidth: 640; displayHeight: 480;
          debugUIEnabled: false;">

    <a-nft
      id="nft-target"
      type="nft"
      url="https://leemile.github.io/AR"
      smooth="true"
      smoothCount="5"
      smoothTolerance="0.08"
      smoothThreshold="2">

      <a-plane
        id="ani-plane"
        position="0 0 0.02"
        rotation="-90 0 0"
        width="2.5" height="2.5"
        visible="false">
      </a-plane>
    </a-nft>

    <a-entity camera></a-entity>
  </a-scene>

  <script>
    window.addEventListener('load', () => {
      const dbg = (msg) => document.getElementById('dbg').textContent = msg;

      const nft = document.querySelector('#nft-target');
      const plane = document.querySelector('#ani-plane');

      const totalFrames = 22;
      const textures = new Array(totalFrames);

      let texturesReady = false;
      let planeMesh = null;
      let material = null;

      let currentIdx = 0;
      let lastUpdate = 0;
      let rafId = null;
      let playing = false;

      // 1) 텍스처 로드
      const loader = new THREE.TextureLoader();
      loader.setCrossOrigin('anonymous');
      let loaded = 0;

      for (let i = 0; i < totalFrames; i++) {
        const frameNum = String(i).padStart(3, '0');
        const url = `https://leemile.github.io/frames/frame_${frameNum}.png`;
        loader.load(url, (tex) => {
          textures[i] = tex;
          loaded++;
          if (loaded === totalFrames) {
            texturesReady = true;
            console.log('All textures loaded');
            dbg('textures ready');
          }
        }, undefined, (err) => {
          console.error('Texture load failed:', url, err);
        });
      }

      // 2) mesh 준비되면 material을 우리가 직접 고정
      const meshCheck = setInterval(() => {
        const mesh = plane.getObject3D('mesh');
        if (!mesh) return;
        clearInterval(meshCheck);

        planeMesh = mesh;

        // A-Frame material 대신 우리가 직접 three material로 고정 (가장 중요)
        material = new THREE.MeshBasicMaterial({
          map: null,
          transparent: true,
          side: THREE.DoubleSide,
          depthTest: false,
          depthWrite: false
        });
        planeMesh.material = material;

        plane.object3D.renderOrder = 999;
        planeMesh.renderOrder = 999;

        console.log('Mesh ready');
        dbg('mesh ready');
      }, 50);

      function setFrame(i) {
        if (!material || !textures[i]) return;
        material.map = textures[i];
        material.needsUpdate = true;
      }

      function loop(t) {
        if (!playing) return;
        if (t - lastUpdate > 80) { // ~12fps
          setFrame(currentIdx);
          currentIdx = (currentIdx + 1) % totalFrames;
          lastUpdate = t;
          dbg(`playing ${currentIdx}`);
        }
        rafId = requestAnimationFrame(loop);
      }

      function start() {
        if (playing) return;
        if (!texturesReady || !planeMesh || !material) return;

        plane.setAttribute('visible', true);
        currentIdx = 0;
        lastUpdate = 0;
        setFrame(0);

        playing = true;
        rafId = requestAnimationFrame(loop);
        console.log('Animation Started');
      }

      function stop() {
        if (!playing) return;
        playing = false;
        if (rafId) cancelAnimationFrame(rafId);
        rafId = null;
        plane.setAttribute('visible', false);
        console.log('Animation Stopped');
        dbg('stopped');
      }

      // 3) NFT 추적 상태를 “이벤트가 아니라” visible로 폴링
      //    nft.object3D.visible 이 true면 추적중인 상태로 보는 방식 (가장 안정적)
      setInterval(() => {
        const tracking = nft.object3D && nft.object3D.visible;
        if (tracking) start();
        else stop();
      }, 100);

      window.addEventListener('arjs-nft-loaded', () => {
        document.getElementById('loader').style.display = 'none';
        dbg('nft loaded');
      });
    });
  </script>
</body>
</html>
